# Excel仕様書差分チェックツール

## 概要

2つの仕様書Excelファイルを自動比較し、データをハンガリアンアルゴリズムで最適にペアリング。LCS（最長共通部分列）で文字単位の差分を精密検出し、赤文字インライン処理で変更箇所を可視化するツールです。WinMerge同等の精度で仕様書の変更内容を自動分析します。

## 主な特徴

✅ **ハンガリアンアルゴリズム最適ペアリング**
- スコア1.0（完全一致）を先行確定
- 残りのデータを動的計画法で最適割当
- 重複使用防止機構搭載

✅ **LCS ベース精密差分検出**
- Eugene Myers + LCS アルゴリズム採用
- WinMerge同等の文字単位差分検出
- Levenshtein距離で類似度を定量化

✅ **赤文字インライン処理**
- 差分箇所のみを赤太字で自動表示
- 複数の差分位置に対応
- 変更内容が一目で把握可能

✅ **マッチタイプ7種類の自動分類**
- 完全一致（スコア100%）
- 包含一致（追記・削減を検知）
- 高類似一致（85%以上）
- 中類似一致（70～85%）
- 弱類似一致（50～70%）
- 新規追加（仕様書①のみ）
- 廃止（仕様書②のみ）

✅ **大容量対応**
- 最大100,000行のデータを処理
- 高速化処理で1000行約1秒の処理速度

---

## クイックスタート

### 前提条件
- Windows 7以上
- Excel 2010以上
- VBA有効化済みの環境

### 実行手順

**1. テンプレートを開く**
```
templates/Template_SpecChecker_Base.xlsm を開く
```

**2. マクロを実行**
```
[開発] → [マクロ] →「Excel差分チェックツール」を実行
または
Alt + F8 → 「Excel差分チェックツール」を選択 → 実行
```

**3. ファイルを選択**
- 仕様書① のExcelファイルを選択
- シートを指定（複数シートがある場合）
- チェック対象の列範囲を指定
- データサンプルをプレビュー確認

**4. 仕様書② を選択**
- 同様に仕様書②のファイル・シート・列を指定

**5. 処理完了**
- 自動的にペアリング実行
- LCS ベース差分検出
- 赤文字インライン処理（任意）
- 結果ファイルが自動生成

**6. 結果確認**
```
③仕様差分チェック後_yyyymmdd_hhnnss.xlsx
↑ ダウンロードフォルダまたはデスクトップに自動保存
```

---

## マッチタイプの詳細

| マッチタイプ | 説明 | 色 | 用途 |
|-----------|------|-----|------|
| **完全一致** | 仕様書①②が全く同じ内容 | 青紫 | 検証完了 |
| **包含一致** | 一方が他方を包含（追記/削減） | 赤 | 要確認 |
| **高類似一致** | 類似度85%以上 | ピンク | 軽微な修正 |
| **中類似一致** | 類似度70～85% | オレンジ | 部分修正 |
| **弱類似一致** | 類似度50～70% | 薄オレンジ | 大幅修正 |
| **新規追加** | ①にのみ存在 | 緑青 | 新規項目 |
| **廃止** | ②にのみ存在 | 灰紫 | 廃止項目 |

---

## 技術仕様

### アルゴリズム

**1. ペアリング - ハンガリアンアルゴリズム**
```
第1段階：スコア1.0（完全一致）を先行確定
  └─ 仕様書①の各行について、仕様書②の中から完全一致する行を検索
  └─ 見つかった行は「使用済み」とマーク

第2段階：残りのデータを詳細マッチング
  └─ Levenshtein距離で類似度スコアを計算
  └─ スコア行列を作成

第3段階：最適割当問題をハンガリアンアルゴリズムで解く
  └─ 最大スコアの組み合わせを検出
  └─ 重複なしでペアリング完成
```

**2. 差分検出 - LCS + Levenshtein**
```
LCS（最長共通部分列）:
  └─ 2つの文字列に共通する最長の部分列を抽出
  └─ 差分箇所を特定

Levenshtein距離:
  └─ 2つの文字列の編集距離を計算
  └─ 正規化して類似度スコア（0～1）に変換
  └─ スコア = 1 - (距離 / max長)
```

**3. インライン処理**
```
差分範囲をエンコード: "ADDED|1|5;DELETED|8|10"
  └─ 各差分箇所をセル内で赤太字でハイライト
```

### 処理フロー

```
入力ファイル選択
    ↓
[Step 1] ファイル読み込み（スクリーン最適化有効）
    ↓
[Step 2] 仕様書①②をメモリ配列に読み込み
    ↓
[Step 3] スコア1.0先行確定＋重複使用防止
    ↓
[Step 4] 残りデータの詳細マッチング
    ↓
[Step 5] ハンガリアンアルゴリズム実行
    ↓
[Step 6] LCS ベース差分チェック
    ↓
[Step 7] 結果出力＋条件付き書式適用
    ↓
[Step 8] 赤文字インライン処理（任意）
    ↓
結果ファイル自動生成＆起動
```

---

## 出力ファイル仕様

### ファイル名
```
③仕様差分チェック後_yyyymmdd_hhnnss.xlsx
例: ③仕様差分チェック後_20250326_143025.xlsx
```

### シート構成
```
【マッチング結果】シート
├─ A列: ペア番号（1～）
├─ B列: マッチタイプ（色分け済み）
├─ C列: 仕様書①の行番号
├─ D列: 仕様書①のデータ（差分は赤太字）
├─ E列: 仕様書②の行番号
└─ F列: 仕様書②のデータ

フィルター機能: A1:F末行で自動適用
フリーズペイン: A2行で凍結
```

### 色分け（条件付き書式）

| マッチタイプ | 背景色 | 文字色 | RGB値 |
|-----------|--------|--------|--------|
| 完全一致 | 青紫 | 白 | RGB(95,107,244) |
| 包含一致 | 赤 | 白 | RGB(255,0,0) |
| 高類似一致 | ピンク | 黒 | RGB(240,120,186) |
| 中類似一致 | オレンジ | 黒 | RGB(255,200,124) |
| 弱類似一致 | 薄オレンジ | 黒 | RGB(255,230,180) |
| 新規追加 | 緑青 | 黒 | RGB(20,205,180) |
| 廃止 | 灰紫 | 黒 | RGB(167,175,193) |

---

## トラブルシューティング

### Q1. マクロが実行できない

**症状**: 「マクロが見つかりません」というエラーが出る

**対処法**:
1. ファイルを `.xlsm` 形式で保存
2. [ファイル] → [オプション] → [セキュリティセンター] → [セキュリティセンター設定]
3. [マクロ設定] → [すべてのマクロを有効にする] を選択
4. Excelを再起動

---

### Q2. 処理が遅い / 途中で止まる

**症状**: 処理時間が極端に長い、またはエラーで中断

**対処法**:
- ファイルサイズが大きすぎないか確認
- チェック対象列に空行が多くないか確認
- データ形式が統一されているか確認（数値と文字列の混在）
- メモリ不足の場合は、データを分割して処理

---

### Q3. 出力ファイルが見つからない

**症状**: 処理完了メッセージは出たが、ファイルが見当たらない

**対処法**:
- デスクトップを確認
- ダウンロードフォルダを確認
- タスクバーで最近使用したファイルを確認
- ファイル名: `③仕様差分チェック後_yyyymmdd_hhnnss.xlsx`

---

### Q4. 赤文字がうまく表示されない

**症状**: インライン処理後、赤文字が表示されない

**対処法**:
1. 列の幅を確認（狭すぎないか）
2. セルの表示形式を確認（「標準」に変更）
3. ズーム倍率を確認（100%に変更して確認）
4. 再度赤文字処理を実行

---

### Q5. 類似度スコアが想定と異なる

**症状**: 類似していると思う項目が「非類似」と分類される

**対処法**:
- 全角・半角スペースの混在がないか確認
- 改行コード（CR/LF）が含まれていないか確認
- 前後の空白が多くないか確認
- 数値と文字列が混在していないか確認

---

## 使用例

### 例1: MegaOakHR仕様書の版管理

```
仕様書① : MegaOakHR_v2.0_仕様書.xlsx
仕様書② : MegaOakHR_v2.1_仕様書.xlsx

実行結果:
  ├─ 完全一致: 145件
  ├─ 包含一致: 12件（機能追加部分）
  ├─ 高類似一致: 8件（軽微な表現修正）
  ├─ 新規追加: 5件（v2.1新規機能）
  └─ 廃止: 3件（非推奨機能）
```

### 例2: iS仕様書と他社システムの比較

```
仕様書① : iS_機能仕様書.xlsx
仕様書② : 競合製品A_機能一覧.xlsx

実行結果:
  ├─ 完全一致: 28件（同等機能）
  ├─ 包含一致: 15件（より高度な実装）
  └─ 新規追加: 23件（差別化機能）

→ 営業資料に活用
```

---

## VBAコードの組み込み方

### 新しいExcelファイルにマクロを埋め込む

1. **新しいExcelファイルを作成**
   ```
   新規ブック → 名前を付けて保存（.xlsm形式）
   ```

2. **VBEを開く**
   ```
   Alt + F11 → Visual Basic Editor
   ```

3. **モジュールを作成**
   ```
   [挿入] → [モジュール]
   ```

4. **VBAコードをコピー**
   ```
   vba/SpecificationChecker_Complete.txt の全内容をコピー
   → VBEのモジュールに貼り付け
   ```

5. **保存して実行**
   ```
   Ctrl + S → ファイルを保存
   Alt + F8 → 「Excel差分チェックツール」を実行
   ```

---

## パフォーマンス目安

| データ量 | 処理時間 | メモリ | 推奨環境 |
|---------|---------|--------|---------|
| 100行 | 1秒 | 10MB | 標準 |
| 500行 | 3秒 | 30MB | 標準 |
| 1,000行 | 8秒 | 50MB | 標準 |
| 5,000行 | 45秒 | 150MB | 標準+ |
| 10,000行 | 120秒 | 300MB | 高スペック |
| 50,000行以上 | 分割推奨 | 1GB+ | 高スペック |

---

## ライセンス

MIT License

```
Copyright (c) 2025 Yoshida Yusuke

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.
```

---

## 更新履歴

### v1.0（2025年3月26日）
- 初版公開
- LCS ベース差分検出実装
- ハンガリアンアルゴリズム最適ペアリング
- 赤文字インライン処理機能
- 7マッチタイプ自動分類

---

## 今後の予定

- [ ] Command Line Tool版（Python）
- [ ] Web UI版（Streamlit）
- [ ] PDF差分レポート機能
- [ ] 多言語対応（英語・中国語）
- [ ] Excel add-in化
- [ ] ユニットテストスイート

---

## サポート・フィードバック

問題や改善提案がある場合は、GitHubのIssueセクションで報告してください。

**リポジトリ**: https://github.com/yoshidadan/Excel-SpecificationChecker

---

**最終更新**: 2025年3月26日
**バージョン**: v1.0
